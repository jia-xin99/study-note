# 2. MSQL进阶篇

## 01 存储引擎

###  （1）mysql体系结构

![](/mysql/1.png)

#### 【1】连接层

- 负责客户端和链接服务，涉及连接处理、认证授权等。该层还有连接池。

#### 【2】服务层 

- 完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如 过程、函数等。在该层，服务器会解 析查询并创建相应的内部解析树，并对其完成相应的优化如确定表的查询的顺序，是否利用索引等， 最后生成相应的执行操作。

#### 【3】引擎层

- 存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API和存储引擎进行通信。数据库中的索引是在存储引擎层实现的。这些引擎是可插拔的。

#### 【4】存储层

- 将数据(如: redolog、undolog、数据、索引、二进制日志、错误日志、查询 日志、慢查询日志等)存储在文件系统之上，并完成与存储引擎的交互。

### （2）存储引擎简介

- 存储引擎是MYSQL核心部分，是**存储数据、建立索引、更新/查询数据**等技术的实现方式；
- 它是基于数据库表的，不是基于数据库的，存储引擎是表类型的；
- 创建表时可以指定存储引擎，在后面加上`ENGINE = InnoDB`即可；
- 查询当前数据库支持的存储引擎：`SHOW ENGINES;`；
- 查询表创建时的存储引擎：`SHOW CREATE TABLE XX;`；（默认是InnoDB）

### （3）存储引擎特点

#### 【1】InnoDB

- 介绍：高可靠性和高性能的通用执行引擎，MySQL默认执行引擎；

- 特点：（事务、行锁、外键约束）

  - DML操作遵循ACID模型，支持事务；
  - 行级锁，提高并发访问性能；
  - 支持外键约束，保证数据完整性和正确性。

- 文件：

  - xxx.ibd：xxx表示表名，innoDB引擎的每张表都会对应这样一个表空间文件，存储该表的表结构（frm、sdi【数据字典】）、数据和索引。
    - 参数：`innodb_file_per_table`（多张表是否共用一个表空间，MYSQL8.0是开启的，每张表对应一个表空间）
      - 查询该参数：`show variables like 'innodb_file_per_table'; ` 

- 逻辑存储结构：

  - 表空间： InnoDB存储引擎逻辑结构的最高层，ibd文件其实就是表空间文件；
  - 段：表空间是由各个段组成的， 常见的段有数据段、索引段、回滚段等。InnoDB中对于段的管 理，都是引擎自身完成，不需要人为对其控制，一个段中包含多个区；
  - 区：区是表空间的单元结构，每个区的大小为1M。 默认情况下， InnoDB存储引擎页大小为16K， 即一个区中一共有64个连续的页；
  - 页：页是组成区的最小单元，页也是InnoDB 存储引擎磁盘管理的最小单元，每个页的大小默认为 16KB。为了保证页的连续性，InnoDB 存储引擎每次从磁盘申请 4-5 个区；
  - 行：InnoDB存储引擎是面向行的，也就是说数据是按行进行存放的，在每一行中除了定义表时所指定的字段以外，还包含两个隐藏字段。

  ![](/mysql/2.png)

#### 【2】MyISAM

- 介绍：MySQL早期的默认存储引擎。
- 特点：
  - 不支持事务，不支持外键；
  - 支持表锁，不支持行锁；
  - 访问速度快。
- 文件：MYD、MYI、SDI文件。（数据、索引、表结构）

#### 【3】Memory

- 介绍：表表数据存储在内存中，智能作为临时表或缓存使用。
- 特点：内存存放、hash索引（默认）
- 文件：xx.sdi（表结构）

#### 【4】对比

![](/mysql/3.png)

#### 【5】InnoDB与MyISAM区别

- InnoDB支持事务，MyISAM不支持；
- InnoDB支持表锁和行锁，MyISAM只支持表锁，不支持行锁；
- InnoDB支持外键约束，MyISAM不支持。

### （4）存储引擎选择

- InnoDB：适合有事务需求、在并发情况下要求一致性、除查询外有大量增删改操作的应用场景；
- MyISAM：适合以读和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高的应用场景；
- MEMORY：将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。MEMORY的缺陷就是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性。

## 02 索引

（1）索引概述

- 用来高效获取数据的数据结构（有序）。该数据结构以某种方式引用（指向）数据，可实现快速查找【类比目录】；

- 无索引，即全表扫描。
- 索引优点：
  - 提高数据检索效率，降低数据库IO成本；
  - 通过索引对数据进行排序，江都数据排序成本，降低CPU消耗；
- 索引缺点：
  - 索引列占用空间；
  - 索引大大提高查询效率，但降低更新表的速度，对表进行增删改时，效率降低（要维护索引表）。

（2）索引结构

- MySQL的索引在存储引擎层实现。

![](/mysql/4.png)

![](/mysql/5.png)

（3）索引结构

- 二叉树：缺点是顺序插入时，会形成一个链表，查询性能大大降低。大数据量情况下，层次较深，检索速度慢；
- 红黑树：大数据量情况下，层次较深，检索速度慢。

![](/mysql/6.png)

- B树（多路平衡二叉树）
  - 

3sql优化
4视图、存储过程、触发器
5锁
6innoDB引擎
7mysql管理